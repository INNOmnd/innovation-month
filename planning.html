<!doctype html>
<html lang="nl">
<head>
  <link rel="icon" type="image/svg+xml" href="casade-logo.svg">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Casade Planning — INNOvember</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --brand:#86BC25; --brand-dark:#5D7A15; }
    .cell { position: relative;
          pointer-events: none;}
    .event {
      position:absolute; 
      /* was: left:2px; right:2px; */
      left:2px;               /* JS controls left + width per lane */
      border-radius:10px; padding:6px 8px 28px; font-size:12px; line-height:1.2;
      background:#E6F3D0; border:1px solid #CDE5A5; cursor:pointer; z-index:1; pointer-events:auto;
      box-shadow: 0 1px 0 rgba(0,0,0,.04);
    }
    .event:hover { outline:2px solid var(--brand); }
    .tab-btn { padding:.5rem .75rem; border-radius:.75rem .75rem 0 0; }
    .tab-btn.active { background: white; border:1px solid #e2e8f0; border-bottom: none; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }

    /* (Bestond al) kleine styles voor availability-list */
    .workshop-list{list-style:none;padding:0;display:grid;gap:1rem}
    .workshop{padding:1rem;border:1px solid #eee;border-radius:.75rem;background:#fff}
    .badge{display:inline-block;padding:.25rem .5rem;border-radius:.5rem;background:#eee;font-size:.9rem;margin-top:.25rem}
    .badge.full{background:#ddd}
    .btn{display:inline-block;margin-top:.5rem;padding:.5rem .75rem;border:1px solid #ccc;border-radius:.5rem;text-decoration:none}

    /* Nieuw: visuele hint voor disabled tab */
    .tab-btn[disabled]{ pointer-events:none; opacity:.5; }

    /* Availability chip inside calendar events */
    .event .avail-chip{
      position:absolute; bottom:8px; left:8px;
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:9999px; font-size:11px; font-weight:600;
      border:1px solid rgba(0,0,0,.06); box-shadow:0 1px 0 rgba(0,0,0,.04);
      background:#F0FDF4; color:#166534;           /* soft green */
    }

    /* Chip icon */
    .event .avail-chip svg{ width:14px; height:14px; display:block; }

    /* Full (= no seats left) */
    .event .avail-chip.full{
      background:#FEF2F2; color:#991B1B;           /* soft red */
      border-color: rgba(153,27,27,.15);
    }

    .nav-link[aria-current="page"]{ color:var(--brand); text-underline-offset:4px; text-decoration:underline; }

  </style>
</head>
<body class="bg-slate-50">
  <header class="sticky top-0 z-30 backdrop-blur bg-white/85 border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="index.html" aria-label="Naar home" class="inline-flex items-center gap-2 shrink-0">
        <img src="casade-logo.svg" alt="Casade" class="h-16 w-auto block" height="64" decoding="async" />
        <span class="sr-only">Casade</span>
      </a>
      <strong class="text-lg md:text-xl font-bold leading-tight" style="color:var(--brand)">
        Planning INNOvember
      </strong>
      <nav class="ml-auto text-sm flex items-center gap-6">
        <a href="index.html" class="nav-link hover:underline hover:text-slate-900 underline-offset-4">Home</a>
        <a href="blog.html" class="nav-link hover:underline hover:text-slate-900 underline-offset-4">Blog</a>
        <a href="planning.html" class="nav-link hover:underline hover:text-slate-900 underline-offset-4">Planning</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <!-- Week navigation -->
    <div class="flex items-center justify-between mb-4">
      <button id="prevWeek" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">Vorige</button>
      <h2 id="weekTitle" class="text-lg font-semibold"></h2>
      <button id="nextWeek" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">Volgende</button>
    </div>

    <!-- Timetable -->
    <div class="overflow-x-auto border border-slate-200 rounded-2xl bg-white">
      <table class="w-full text-sm">
        <thead class="bg-slate-100">
          <tr>
            <th class="w-24 p-3 text-left">Tijd</th>
            <th class="p-3 text-left">Maandag</th>
            <th class="p-3 text-left">Dinsdag</th>
            <th class="p-3 text-left">Woensdag</th>
            <th class="p-3 text-left">Donderdag</th>
            <th class="p-3 text-left">Vrijdag</th>
          </tr>
        </thead>
        <tbody id="grid"></tbody>
      </table>
    </div>
    <p class="text-xs text-slate-500 mt-2">Klik op een sessie voor details of inschrijven.</p>

    <!-- Availability-lijst (NIET tonen onderaan de planning) -->
    <section class="mt-8 hidden" id="availSection">
      <h3 class="text-base font-semibold mb-2">Beschikbaarheid per workshop</h3>
      <ul id="workshops" class="workshop-list"></ul>
      <p class="text-xs text-slate-500 mt-1">Tip: Klik “Inschrijven” om het formulier in deze pagina te openen.</p>
    </section>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 hidden z-50 items-center justify-center bg-black/50 overflow-y-auto p-4">
      <div class="bg-white max-w-2xl w-[92vw] rounded-2xl p-6 max-h-[90vh] overflow-y-auto">
        <div class="flex items-start gap-4">
          <img id="mBanner" class="w-24 h-24 object-cover rounded-xl border border-slate-200" alt="" />
          <div>
            <h3 id="mTitle" class="text-xl font-bold"></h3>
            <p id="mMeta" class="text-sm text-slate-600"></p>
          </div>
          <button id="closeModal" class="ml-auto text-slate-600">✕</button>
        </div>

        <!-- Tabs -->
        <div class="mt-4">
          <div class="flex gap-2 border-b border-slate-200">
            <button id="tab-info" class="tab-btn active">Info</button>
            <button id="tab-inschrijven" class="tab-btn">Inschrijven</button>
          </div>

          <!-- Tab: Info -->
          <div id="panel-info" class="tab-content active border border-slate-200 rounded-b-2xl rounded-tr-2xl p-4">
            <p id="mDesc" class="text-slate-700"></p>
            <!-- Nieuw: beschikbaarheid in de Info-tab -->
            <p id="mAvail" class="mt-2 text-sm text-slate-600"></p>
          </div>

          <!-- Tab: Inschrijven -->
          <div id="panel-inschrijven" class="tab-content border border-slate-200 rounded-b-2xl rounded-tr-2xl p-0 overflow-y-auto">
            <!-- Iframe injected on demand -->
            <div id="mFormLoader" class="p-4 text-sm text-slate-500">Formulier laden…</div>
            <div id="mForm"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Use November of this year (if Nov already passed, use next year)
    const today=new Date();
    const currentYear = (today.getMonth() <= 10) ? today.getFullYear() : today.getFullYear()+1; // 0-based; 10 = Nov
    const NOVEMBER=10;

    // Workshops (edit as needed)
    const WORKSHOPS=[
      { id:'taal-tool', title:'Taaltool Sessie 1', date:`${currentYear}-11-05`, start:'09:30', end:'11:30', speaker:'Joan', banner:'pictures/taaltool.png', desc:'Verkenning van de taaltool' },
      { id:'aftrap', title:'De Aftrap', date:`${currentYear}-11-11`, start:'09:00', end:'11:00', speaker:'Ergin', banner:'pictures/aftrap.png', desc:'We nemen jullie mee in het hele plaatje van innovatie.' },
      { id:'wrk-ai-beginner', title:'Werken met AI beginner', date:`${currentYear}-11-11`, start:'13:00', end:'15:00', speaker:'Job', banner:'pictures/werkenmetai.png', desc:'Een AI cursus voor beginners' },
      { id:'goeie-buurtaal-ai', title:'Goeie Buur-taal met AI', date:`${currentYear}-11-13`, start:'09:00', end:'11:00', speaker:'Amy en Wendy', banner:'pictures/buurtaal.png', desc:'Gebruik AI om jouw goeie buurtaal te verbeteren.' },
      { id:'dwam', title:'Drone With A Mission', date:`${currentYear}-11-13`, start:'11:00', end:'13:00', speaker:'Ruud Janssen', banner:'pictures/dwam.png', desc:'Zie hoe drones in ons werkveld zorgen voor innovatie.' },
      { id:'taal-tool2',title:'Taaltool Sessie 2', date:`${currentYear}-11-13`, start:'10:00', end:'12:00', speaker:'Joan', banner:'pictures/taaltool.png',  desc:'Verkenning van de taaltool.' },
      { id:'wrk-ai-intermediate', title:'Werken met AI Gevorderd', date:`${currentYear}-11-13`, start:'13:00', end:'15:00', speaker:'Job', banner:'pictures/werkenmetai.png', desc:'Werken met AI voor gevorderden.' },
      { id:'shortcut', title:'The Shortcut', date:`${currentYear}-11-17`, start:'09:00', end:'11:00', speaker:'Sanne Cornelissen', banner:'pictures/sanna.jpg', desc:'Leer AI toe te passen in jouw werk.' },
      { id:'agile-scrum', title:'Agile Scrum', date:`${currentYear}-11-18`, start:'13:00', end:'15:00', speaker:'Rogier', banner:'pictures/aftrap.png', desc:'Agile scrum.' },
      { id:'omaia', title:'OMAIA Sessie 1', date:`${currentYear}-11-20`, start:'09:00', end:'11:00', speaker:'Rogier', banner:'pictures/omaia.png', desc:'OMAIA.' },
      { id:'thuisapp', title:'Thuisapp Sessie 1', date:`${currentYear}-11-20`, start:'10:00', end:'12:00', speaker:'Tessa', banner:'pictures/thuisapp.png', desc:'Thuisapp.' },
      { id:'omaia2', title:'OMAIA Sessie 2', date:`${currentYear}-11-20`, start:'13:00', end:'15:00', speaker:'Tessa', banner:'pictures/omaia.png', desc:'OMAIA.' },
      { id:'thuisapp2', title:'Thuisapp Sessie 2', date:`${currentYear}-11-20`, start:'15:00', end:'17:00', speaker:'Tessa', banner:'pictures/thuisapp.png', desc:'Thuisapp.' },
      { id:'goeie-buurtaal', title:'Goeie Buurtaal', date:`${currentYear}-11-25`, start:'11:00', end:'13:00', speaker:'Amy en Wendy', banner:'pictures/buurtaal.png', desc:'Goeie buurtaal zonder AI.' },
      { id:'taal-tool3',title:'Taaltool Sessie 3', date:`${currentYear}-11-27`, start:'12:30', end:'14:00', speaker:'Joan', banner:'pictures/taaltool.png', desc:'Taaltool.' }
    ];

    // Map workshop IDs to Microsoft Forms embed URLs
    const formLinks = {
      "taal-tool": "https://forms.office.com/Pages/ResponsePage.aspx?id=0YvUK1a-i0OZ8wod-zrRqXmwJqIUyTxEgXwvF60HDQNUOEg2VE5CTTZBRlhUSkMwS0IxMlpRWURRUC4u&embed=true",
      "aftrap": "https://forms.office.com/Pages/ResponsePage.aspx?id=0YvUK1a-i0OZ8wod-zrRqXmwJqIUyTxEgXwvF60HDQNUQlNGQzM1NFNPRllUQTlOTUM4SDRENVI3Si4u&embed=true",
      "wrk-ai-beginner": "FORM_URL_AI_BEGINNER",
      "goeie-buurtaal-ai": "FORM_URL_BUURTAAL_AI",
      "dwam": "FORM_URL_DWAM",
      "taal-tool2": "FORM_URL_TAALTOOL2",
      "wrk-ai-intermediate": "FORM_URL_AI_ADVANCED",
      "shortcut": "FORM_URL_SHORTCUT",
      "agile-scrum": "FORM_URL_AGILE",
      "omaia": "FORM_URL_OMAIA1",
      "thuisapp": "FORM_URL_THUISAPP1",
      "omaia2": "FORM_URL_OMAIA2",
      "thuisapp2": "FORM_URL_THUISAPP2",
      "goeie-buurtaal": "FORM_URL_BUURTAAL",
      "taal-tool3": "FORM_URL_TAALTOOL3"
    };

    // BESCHIKBAARHEID (nu per-workshop file i.p.v. één lijst)
    let AVAIL = {}; // { id: {capacity, registered, ...}, ... }

    // Build weeks of November (Mon–Fri)
    function getWeeks(year){
      const first=new Date(year, NOVEMBER, 1);
      const last=new Date(year, NOVEMBER+1, 0);
      const start=new Date(first);
      const day=(start.getDay()+6)%7; // Mon=0
      start.setDate(start.getDate()-day);
      const weeks=[];
      let cur=new Date(start);
      while(cur<=last){
        const days=[];
        for(let i=0;i<5;i++){ const d=new Date(cur); d.setDate(cur.getDate()+i); days.push(new Date(d)); }
        weeks.push(days);
        cur.setDate(cur.getDate()+7);
      }
      return weeks;
    }

    const weeks=getWeeks(currentYear);
    let weekIdx=1;

    const grid=document.getElementById('grid');
    const weekTitle=document.getElementById('weekTitle');

    function timeToIdx(t){ const [h,m]=t.split(':').map(Number); return (h-9)*2 + (m>=30?1:0); } // 09:00 baseline

    function renderWeek(){
      const days=weeks[weekIdx];
      const opts={ day:'2-digit', month:'short' };
      weekTitle.textContent=`Week ${weekIdx+1} • ${days[0].toLocaleDateString(undefined,opts)} – ${days[4].toLocaleDateString(undefined,opts)} ${currentYear}`;

      // times 09:00..17:00 per 30 min slots
      const times=[]; for(let h=9; h<=17; h++){ times.push(`${String(h).padStart(2,'0')}:00`); if(h<17) times.push(`${String(h).padStart(2,'0')}:30`); }
      grid.innerHTML='';
      times.forEach(t=>{
        const tr=document.createElement('tr');
        const th=document.createElement('th'); th.className='align-top p-2 w-24 text-left text-slate-600'; th.textContent=t; tr.appendChild(th);
        for(let c=0;c<5;c++){ const td=document.createElement('td'); td.className='relative h-14 align-top border-t border-slate-100 cell'; tr.appendChild(td); }
        grid.appendChild(tr);
      });

      const rows=grid.querySelectorAll('tr');
      const slotHeight=rows[0].children[1].getBoundingClientRect().height || 56;

      // Collect events per weekday for this week (Mon..Fri)
      const startOfWeek=days[0]; const endOfWeek=days[4];
      const weekEvents=WORKSHOPS.filter(w=>{ const d=new Date(w.date); return d>=new Date(startOfWeek.toDateString()) && d<=new Date(endOfWeek.toDateString()); });

      // Group by weekday (0..4 => Mon..Fri)
      const byDay=[[],[],[],[],[]];
      weekEvents.forEach(ev=>{
        const d=new Date(ev.date); const col=((d.getDay()+6)%7);
        if(col<=4) byDay[col].push(ev);
      });

      // ---- Render events (fixed overlap + width per lane) ----
      byDay.forEach((events, col) => {
        // sort stable: start, then end
        events.sort((a,b)=> timeToIdx(a.start) - timeToIdx(b.start) || timeToIdx(a.end) - timeToIdx(b.end));

        const active = [];
        let cluster = [];
        let clusterMaxLane = -1;

        function finalizeCluster(){
          const total = clusterMaxLane + 1;
          cluster.forEach(ev => ev._lanes = total);
          cluster = [];
          clusterMaxLane = -1;
        }

        // assign lanes + clusters
        events.forEach(ev => {
          const s = timeToIdx(ev.start);
          const e = timeToIdx(ev.end);

          // drop finished from active
          for (let i = active.length - 1; i >= 0; i--) {
            if (active[i].end <= s) active.splice(i,1);
          }

          // if no active, a new cluster starts
          if (active.length === 0 && cluster.length) finalizeCluster();

          // pick first free lane index
          const used = new Set(active.map(a => a.lane));
          let lane = 0; while (used.has(lane)) lane++;
          ev._lane = lane;
          ev._startIdx = s;
          ev._endIdx = e;

          active.push({ end: e, lane });
          cluster.push(ev);
          if (lane > clusterMaxLane) clusterMaxLane = lane;
        });

        if (cluster.length) finalizeCluster();

        // paint
        events.forEach(ev => {
          const startCell = rows[ev._startIdx].children[col + 1];
          const div = document.createElement('div');
          div.className = 'event';

          const durationRows = Math.max(1, ev._endIdx - ev._startIdx);
          div.style.top = '2px';
          div.style.height = `calc(${durationRows * slotHeight}px - 4px)`;

          // width/left per lane within the day column
          const gap = 4;
          const widthPct = 100 / ev._lanes;
          div.style.width = `calc(${widthPct}% - ${gap}px)`;
          div.style.left  = `calc(${ev._lane * widthPct}% + 2px)`;

          div.innerHTML=`<strong>${ev.title}</strong><br><span>${ev.start}–${ev.end}</span><br><em>${ev.speaker}</em>`;

          // Nieuw: moderne chip met beschikbaarheid in het roosterblok
          (function(){
            const a = AVAIL[ev.id];
            if (!a) return;
          
            const left = Math.max((a.capacity ?? 0) - (a.registered ?? 0), 0);
            const isFull = left === 0;
          
            const chip = document.createElement('div');
            chip.className = `avail-chip ${isFull ? 'full' : ''}`;
            chip.setAttribute('aria-label', isFull ? 'Vol' : `${left} plekken vrij`);
          
            // Inline SVG icons
            const icon = isFull
              ? `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                   <path d="M6 10V8a6 6 0 1112 0v2M5 10h14v8a2 2 0 01-2 2H7a2 2 0 01-2-2v-8z"
                         stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                 </svg>`
              : `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                   <path d="M9 12l2 2 4-4M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10z"
                         stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                 </svg>`;
          
            chip.innerHTML = `${icon}<span>${isFull ? 'Vol' : `${left} vrij`}</span>`;
            div.appendChild(chip);
          })();

          div.addEventListener('click',()=>openModal(ev));
          startCell.appendChild(div);
        });
      });
      // ---- end render events ----
    }

    // --- Modal logic with tabs ---
    let currentWorkshopId = null;

    function openModal(ev){
      currentWorkshopId = ev.id;

      // Fill header
      document.getElementById('mBanner').src=ev.banner;
      document.getElementById('mTitle').textContent=ev.title;
      document.getElementById('mMeta').textContent=`${new Date(ev.date).toLocaleDateString()} • ${ev.start}–${ev.end} • ${ev.speaker}`;

      // Fill info tab
      document.getElementById('mDesc').textContent=ev.desc;

      // Nieuw: Toon beschikbaarheid in Info-tab en disable Inschrijven-tab indien vol
      (function(){
        const a = AVAIL[ev.id];
        const left = a ? Math.max((a.capacity ?? 0) - (a.registered ?? 0), 0) : null;

        const mAvail = document.getElementById('mAvail');
        if (left === null) {
          mAvail.textContent = '';
        } else if (left === 0) {
          mAvail.textContent = 'Beschikbaarheid: VOL';
        } else {
          mAvail.textContent = `Beschikbaarheid: ${left} plekken over`;
        }

        const tabBtn = document.getElementById('tab-inschrijven');
        if (left === 0) {
          tabBtn.disabled = true;
          tabBtn.classList.add('opacity-50','cursor-not-allowed');
        } else {
          tabBtn.disabled = false;
          tabBtn.classList.remove('opacity-50','cursor-not-allowed');
        }
      })();

      // Reset tabs
      activateTab('info', false); // don't load form yet
      document.getElementById('mForm').innerHTML = '';
      document.getElementById('mFormLoader').style.display = '';

      // Show modal
      const modal=document.getElementById('modal');
      modal.classList.remove('hidden'); modal.classList.add('flex');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      document.getElementById('modal').classList.add('hidden');
      document.body.style.overflow = '';
      // optional: stop loading/unload iframe to save resources
      document.getElementById('mForm').innerHTML = '';
    }

    // Tab activation helper
    function activateTab(which, loadForm = true){
      const btnInfo = document.getElementById('tab-info');
      const btnReg  = document.getElementById('tab-inschrijven');
      const panelInfo = document.getElementById('panel-info');
      const panelReg  = document.getElementById('panel-inschrijven');

      if(which === 'info'){
        btnInfo.classList.add('active'); btnReg.classList.remove('active');
        panelInfo.classList.add('active'); panelReg.classList.remove('active');
      } else {
        btnReg.classList.add('active'); btnInfo.classList.remove('active');
        panelReg.classList.add('active'); panelInfo.classList.remove('active');

        if(loadForm){
          loadFormIframe(currentWorkshopId);
        }
      }
    }

    function loadFormIframe(workshopId){
      const url = formLinks[workshopId];
      const container = document.getElementById('mForm');
      const loader = document.getElementById('mFormLoader');
      container.innerHTML = '';

      if(!url){
        loader.textContent = 'Geen inschrijfformulier beschikbaar.';
        return;
      }

      const iframe = document.createElement('iframe');
      iframe.width = '100%';
      iframe.height = '900';
      iframe.style.height = '70vh';
      iframe.style.maxHeight = '900px';
      iframe.style.border = '0';
      iframe.style.minHeight = '600px';
      iframe.setAttribute('frameborder','0');
      iframe.setAttribute('allowfullscreen','');
      iframe.src = url;

      // Show loader until first load event
      loader.style.display = '';
      iframe.addEventListener('load', () => { loader.style.display = 'none'; }, { once: true });

      container.appendChild(iframe);
    }

    // Close when clicking the dark backdrop (outside the card)
    document.getElementById('modal').addEventListener('click', (e) => {if (e.target === e.currentTarget) closeModal();});

    // Close with Escape key
    document.addEventListener('keydown', (e) => {if (e.key === 'Escape') closeModal();});
    
    // Wire up UI controls
    document.getElementById('closeModal').addEventListener('click', closeModal);
    document.getElementById('tab-info').addEventListener('click', () => activateTab('info', false));
    document.getElementById('tab-inschrijven').addEventListener('click', () => activateTab('inschrijven', true));
    document.getElementById('prevWeek').addEventListener('click',()=>{ weekIdx=Math.max(0,weekIdx-1); renderWeek(); });
    document.getElementById('nextWeek').addEventListener('click',()=>{ weekIdx=Math.min(weeks.length-1,weekIdx+1); renderWeek(); });

    // ---------- Nieuw: per-workshop availability ----------
    // ---------- VERVANG HELE FUNCTIE ----------
async function fetchAvailabilityFor(id){
  const tryPaths = [
    `data/availability/${id}.json`,
    `data/${id}.json`
  ];

  // helpers
  const toNum = (v) => {
    if (v === null || v === undefined || v === '') return null;
    const n = Number(String(v).replace(',', '.').trim());
    return Number.isFinite(n) ? n : null;
  };
  const firstNonNull = (...vals) => vals.find(v => v !== null && v !== undefined);

  for (const path of tryPaths){
    try{
      const res = await fetch(path, { cache: 'no-store' });
      if (!res.ok) continue;

      const json = await res.json();

      // vang verschillende sleutel-namen op (NL/EN/varianten)
      const capRaw = firstNonNull(
        json.capacity, json.cap, json.max, json.maxSeats, json.max_seats,
        json.places, json.plaatsen, json.aantal, json.total
      );
      const regRaw = firstNonNull(
        json.registered, json.registrations, json.taken, json.occupied,
        json.ingeschreven, json.inschrijvingen
      );

      const capacity   = toNum(capRaw);
      const registered = toNum(regRaw);

      // Belangrijk: eerst ...json en daarna onze genormaliseerde velden
      return {
        ...json,
        id,
        capacity: capacity ?? 0,
        registered: registered ?? 0
      };
    } catch(e){
      // probeer volgende pad
    }
  }
  return null;
}

    async function loadAllAvailability(){
      const ids = [...new Set(WORKSHOPS.map(w => w.id))];
      const results = await Promise.allSettled(ids.map(fetchAvailabilityFor));
      const map = {};
      results.forEach((r, idx) => {
        if(r.status === 'fulfilled' && r.value){
          map[r.value.id] = r.value;
        } else {
          // If a file is missing, we leave it out (no badge shown)
          // console.warn(`No availability file for ${ids[idx]}`);
        }
      });
      AVAIL = map;
    }
    // ------------------------------------------------------

    // Beschikbaarheid-lijst opbouwen uit AVAIL (sectie blijft hidden om je layout niet te wijzigen)
    function buildAvailabilityList(){
      const byId = Object.fromEntries(WORKSHOPS.map(w => [w.id, w]));
      const $ul = document.getElementById('workshops');
      if(!$ul) return;

      $ul.innerHTML = '';
      Object.keys(AVAIL).forEach(id => {
        const a = AVAIL[id];
        const left = Math.max((a.capacity ?? 0) - (a.registered ?? 0), 0);
        const meta = byId[id] || { title: id };
        const li = document.createElement('li');
        li.className = 'workshop';
        li.innerHTML = `
          <h3 class="font-semibold">${meta.title}</h3>
          <span class="badge ${left===0 ? 'full' : ''}">
            ${left===0 ? 'Vol' : `${left} plekken over`}
          </span>
          ${left===0 ? '' : `<p><button class="btn" data-wsid="${id}">Inschrijven</button></p>`}
        `;
        $ul.appendChild(li);
      });

      // open modal op "Inschrijven" en ga direct naar Inschrijven-tab
      $ul.addEventListener('click', (e) => {
        const btn = e.target.closest('button.btn');
        if(!btn) return;
        const id = btn.dataset.wsid;
        const ev = WORKSHOPS.find(x => x.id === id);
        if(ev){
          openModal(ev);
          activateTab('inschrijven', true);
        }
      }, { once: true });
    }

    // Render flow
    async function renderWorkshops(){
      try{
        await loadAllAvailability();   // <-- per-file fetch
        buildAvailabilityList();       // (optional UI list; section remains hidden)
        renderWeek();                  // draw calendar badges using AVAIL
      }catch(err){
        console.error('Fout bij laden beschikbaarheid', err);
        const $ul = document.getElementById('workshops');
        if($ul) $ul.innerHTML = '<li class="text-sm text-slate-500">Kon de beschikbaarheid niet laden.</li>';
        renderWeek();
      }
    }

    renderWeek();
    renderWorkshops();
  </script>

  <script>
  (() => {
    const here = location.pathname.split('/').pop() || 'index.html';
    document.querySelectorAll('.nav-link').forEach(a => {
      if (a.getAttribute('href') === here) a.setAttribute('aria-current','page');
    });
  })();
  </script>
</body>
</html>
