<!doctype html>
<html lang="nl">
<head>
  <link rel="icon" type="image/svg+xml" href="pictures/beeldmerk-casade-transp.svg">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Planning Innovember </title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --brand:#86BC25; --brand-dark:#5D7A15; }

    /* ——— Events in grid ——— */
    .cell { position: relative; pointer-events: none;}
    .event {
      position:absolute; left:2px; /* lane math sets width+left in JS */
      border-radius:10px; padding:6px 8px 28px; font-size:12px; line-height:1.2;
      background:#E6F3D0; border:1px solid #CDE5A5; cursor:pointer; z-index:1; pointer-events:auto;
      box-shadow: 0 1px 0 rgba(0,0,0,.04);
    }
    .event:hover { outline:2px solid var(--brand); }

    .event .avail-chip {
      position: absolute;
      bottom: 8px;
      left: 8px;
    
      display: inline-flex;
      align-items: center;
      gap: 4px;
    
      padding: 4px 10px;
      border-radius: 9999px;
      font-size: 12px;
      font-weight: 600;
      line-height: 1;
    
      background: #F0FDF4;
      color: #166534;
      border: 1px solid #BBF7D0;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    
    .event .avail-chip svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }
    
    .event .avail-chip.full {
      background: #FEF2F2;
      color: #991B1B;
      border-color: #FECACA;
    }

    /* icon-only pill for not-open */
    .event .avail-chip.icon-only{
      padding: 6px;            /* small circular pill */
      width: 28px;
      height: 28px;
      border-radius: 9999px;
      justify-content: center;
    }
    
    .event .avail-chip.not-open {
      background: #FFF7ED;   
      color: #92400E;      
      border-color: #FED7AA; 
    }

    /* ——— Modal tabs ——— */
    .tab-btn { padding:.5rem .75rem; border-radius:.75rem .75rem 0 0; }
    .tab-btn.active { background:#fff; border:1px solid #e2e8f0; border-bottom:none; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    .tab-btn[disabled]{ pointer-events:none; opacity:.5; }

    /* ——— Availability list (kept hidden unless used) ——— */
    .workshop-list{list-style:none;padding:0;display:grid;gap:1rem}
    .workshop{padding:1rem;border:1px solid #eee;border-radius:.75rem;background:#fff}
    .badge{display:inline-block;padding:.25rem .5rem;border-radius:.5rem;background:#eee;font-size:.9rem;margin-top:.25rem}
    .badge.full{background:#ddd}
    .btn{display:inline-block;margin-top:.5rem;padding:.5rem .75rem;border:1px solid #ccc;border-radius:.5rem;text-decoration:none}

    /* ——— Nav + header ——— */
    .nav-link[aria-current="page"]{ color:var(--brand); text-underline-offset:4px; text-decoration:underline; }
    .link-underline{
      background-image:linear-gradient(currentColor,currentColor);
      background-repeat:no-repeat; background-position:0 100%;
      background-size:0% 2px; transition:background-size .25s ease;
    }
    .link-underline:hover{ background-size:100% 2px; }

    #siteHeader{ background-color: rgba(255,255,255,.85); transition: background-color .25s ease, box-shadow .25s ease; }
    body.scrolled #siteHeader{ background-color: rgba(255,255,255,.72); box-shadow: 0 1px 0 rgba(0,0,0,.06); }

    /* ——— Calendar table ——— */
    #calendarWrap thead th{
      position: sticky; top: 0; z-index: 20;
      background: #f1f5f9; box-shadow: 0 1px 0 rgba(0,0,0,.06);

    /* Make borders render predictably */
    #timetable { border-collapse: separate; border-spacing: 0; }
    
    /* Vertical lines that always show (inside the cells) */
    #timetable thead th + th { box-shadow: inset 1px 0 0 #e5e7eb; }
    #timetable tbody td + td { box-shadow: inset 1px 0 0 #e5e7eb; }

    /* Outlook-style day headers */
    .dayhead { line-height: 1.1; text-align:left; }
    .dayhead .d { font-size: 1.125rem; font-weight: 700; } 
    .dayhead .w { font-size: .75rem; color: #475569; }     
  
    }
    @media (max-width: 640px){ .event{ font-size:11px; padding:6px 6px 24px; } }
    @media (max-width: 768px){
      #calendarWrap th:first-child{ position:sticky; left:0; z-index:25; background:#fff; }
    }

    /* ——— Compact planner bar ——— */
    .planner-bar { border-radius: 12px; }
    .planner-btn { border-radius: 10px; }
    .planner-bar h2 { margin: 0; }
    #weekRange { word-break: keep-all; }
    #weekChip  { transition: border-color .2s ease, box-shadow .2s ease; }
    #weekChip:hover { border-color: rgba(0,0,0,.15); box-shadow: 0 1px 0 rgba(0,0,0,.06); }

    /* —— Rich description styling (NEW) —— */
    .rich-desc { line-height: 1.6; }
    .rich-desc h1, .rich-desc h2, .rich-desc h3 { margin-top: .75rem; font-weight: 700; }
    .rich-desc p { margin: .5rem 0; }
    .rich-desc ul, .rich-desc ol { margin: .5rem 1.25rem; padding-left: 1rem; }
    .rich-desc img { max-width: 100%; height: auto; border-radius: .5rem; border:1px solid #e5e7eb; }
    .rich-desc a { color: #0ea5e9; text-decoration: underline; text-underline-offset: 3px; }
    /* ensure bullets always render inside rich descriptions */
    .rich-desc ul,
    .rich-desc ol { margin: .5rem 0 .5rem 1.25rem; padding-left: .25rem; }
    
    .rich-desc ul { list-style: disc outside; }
    .rich-desc ol { list-style: decimal outside; }
    
    /* make sure list items actually show a bullet/number */
    .rich-desc li { display: list-item; list-style: inherit; }
  </style>
</head>
<body class="bg-slate-50">
  <header id="siteHeader" class="sticky top-0 z-30 backdrop-blur bg-white/85 border-b border-slate-200">
    <div class="absolute inset-x-0 top-0 h-1" style="background:linear-gradient(90deg,#86BC25,#5D7A15)"></div>
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="index.html" aria-label="Naar home" class="inline-flex items-center gap-2 shrink-0">
        <img src="casade-logo.svg" alt="Casade" class="h-16 w-auto block" height="64" decoding="async" />
      </a>
      <strong class="text-xl font-bold leading-tight" style="color:var(--brand)">
        Planning INNOvember
      </strong>
      <nav class="ml-auto text-sm flex items-center gap-6">
        <a href="index.html" class="nav-link link-underline hover:text-slate-900">Home</a>
        <a href="blog.html" class="nav-link link-underline hover:text-slate-900">Leesvoer</a>
        <a href="planning.html" class="nav-link link-underline hover:text-slate-900">Planning</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- ——— COMPACT PLANNER BAR ——— -->
    <section class="planner-bar-wrap mb-3">
      <div class="planner-bar flex items-center justify-between gap-3 rounded-xl border border-slate-200 bg-white/80 backdrop-blur px-3 py-2 shadow-sm">
        <!-- Left -->
        <button id="prevWeek" class="planner-btn inline-flex items-center gap-2 border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-800 hover:bg-slate-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--brand)]">
          <svg viewBox="0 0 24 24" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
          <span>Vorige</span>
        </button>

        <!-- Center -->
        <div class="min-w-0 text-center leading-tight">
          <h2 id="weekRange" class="text-base md:text-lg font-bold text-slate-900"></h2>
          <div class="mt-1 flex items-center justify-center">
            <span id="weekChip" class="inline-flex items-center gap-1 rounded-full border border-slate-300 px-2 py-0.5 text-xs font-semibold" style="color:var(--brand)">
              <svg viewBox="0 0 24 24" class="h-3.5 w-3.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/>
              </svg>
              <span id="weekChipLabel">Week</span>
            </span>
          </div>
        </div>

        <!-- Right -->
        <button id="nextWeek" class="planner-btn inline-flex items-center gap-2 border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-800 hover:bg-slate-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--brand)]">
          <span>Volgende</span>
          <svg viewBox="0 0 24 24" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
        </button>
      </div>
    </section>

    <!-- ——— DESKTOP CALENDAR ——— -->
    <div id="calendarWrap" class="hidden md:block overflow-auto border border-slate-200 rounded-2xl bg-white">
      <table class="w-full text-sm" id="timetable">
        <thead class="bg-slate-100">
          <tr>
            <th class="w-24 p-3 text-left">Tijd</th>
            <th class="p-3 text-left">Maandag</th>
            <th class="p-3 text-left">Dinsdag</th>
            <th class="p-3 text-left">Woensdag</th>
            <th class="p-3 text-left">Donderdag</th>
            <th class="p-3 text-left">Vrijdag</th>
          </tr>
        </thead>
        <tbody id="grid"></tbody>
      </table>
    </div>

    <!-- ——— MOBILE LIST ——— -->
    <section id="mobileAgenda" class="md:hidden mt-4">
      <div id="mobileList" class="space-y-4"></div>
    </section>
    <p class="text-xs text-slate-500 mt-2">Klik op een sessie voor details of inschrijven.</p>

    <!-- ——— OPTIONAL AVAILABILITY LIST (kept hidden) ——— -->
    <section class="mt-8 hidden" id="availSection">
      <h3 class="text-base font-semibold mb-2">Beschikbaarheid per workshop</h3>
      <ul id="workshops" class="workshop-list"></ul>
      <p class="text-xs text-slate-500 mt-1">Tip: Klik “Inschrijven” om het formulier in deze pagina te openen.</p>
    </section>

    <!-- ——— MODAL ——— -->
    <div id="modal" class="fixed inset-0 hidden z-50 items-center justify-center bg-black/50 overflow-y-auto p-4">
      <div class="bg-white max-w-2xl w-[92vw] rounded-2xl p-6 max-h-[90vh] overflow-y-auto">
        <div class="flex items-start gap-4">
          <img id="mBanner" class="w-24 h-24 object-contain rounded-xl border border-slate-200 shrink-0 bg-white p-1" alt="" />
          <div>
            <h3 id="mTitle" class="text-xl font-bold"></h3>
            <p id="mMeta" class="text-sm text-slate-600"></p>
          </div>
          <button id="closeModal" class="ml-auto text-slate-600">✕</button>
        </div>

        <div class="mt-4">
          <div class="flex gap-2 border-b border-slate-200">
            <button id="tab-info" class="tab-btn active">Info</button>
            <button id="tab-inschrijven" class="tab-btn">Inschrijven</button>
          </div>

          <div id="panel-info" class="tab-content active border border-slate-200 rounded-b-2xl rounded-tr-2xl p-4">
            <!-- CHANGED: allow HTML -->
            <div id="mDesc" class="rich-desc text-slate-700"></div>
            <p id="mAvail" class="mt-2 text-sm text-slate-600"></p>
          </div>

          <div id="panel-inschrijven" class="tab-content border border-slate-200 rounded-b-2xl rounded-tr-2xl p-0 overflow-y-auto">
            <div id="mFormLoader" class="p-4 text-sm text-slate-500">Formulier laden…</div>
            <div id="mForm"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="workshops.js"></script>
  <script>
    // ——— Year & month constants ———
    const today = new Date();
    const currentYear = (today.getMonth() <= 10) ? today.getFullYear() : today.getFullYear() + 1; // Nov=10
    const NOVEMBER = 10;
    // Grid time range (minutes since midnight)
    const GRID_START_MIN = 8 * 60 + 30;  // 08:30
    const GRID_END_MIN   = 17 * 60;      // 17:00

    // ——— Load workshops regardless of how workshops.js defines them ———
    const WORKSHOPS = (() => {
      if (Array.isArray(window.WORKSHOPS)) return window.WORKSHOPS;
      try { if (Array.isArray(WORKSHOPS)) return WORKSHOPS; } catch {}
      console.warn('Geen workshops geladen — controleer workshops.js of het pad naar het bestand.');
      return [];
    })();

    // ——— Availability map ———
    let AVAIL = {};

    // ——— Enrollment state helper ———
    function getEnrollmentState(ev) {
      // Manual override
      if (ev.status === 'closed') {
        return { state: 'not_open', left: null };
      }
      // Time-based override
      if (ev.openAt) {
        const now = new Date();
        const openTime = new Date(ev.openAt);
        if (now < openTime) return { state: 'not_open', left: null };
      }
    
      // Fall back to availability (capacity - registered)
      const a = AVAIL[ev.id];
      if (!a) return { state: 'unknown', left: null };
    
      const left = Math.max((a.capacity ?? 0) - (a.registered ?? 0), 0);
      if (left === 0) return { state: 'full', left: 0 };
      return { state: 'open', left };
    }
    
    // ——— Build November weeks (Mon–Fri) ———
    function getWeeks(year){
      const first = new Date(year, NOVEMBER, 1);
      const last  = new Date(year, NOVEMBER+1, 0);
      const start = new Date(first);
      const day = (start.getDay()+6)%7; // Mon=0
      start.setDate(start.getDate() - day); 
      const weeks = [];
      let cur = new Date(start);
      while(cur <= last){
        const days = [];
        for(let i=0;i<5;i++){ const d=new Date(cur); d.setDate(cur.getDate()+i); days.push(new Date(d)); }
        weeks.push(days);
        cur.setDate(cur.getDate()+7);
      }
      return weeks;
    }

    const weeks = getWeeks(currentYear);
    let weekIdx = 1;

    const grid = document.getElementById('grid');

    // map "HH:MM" to half-hour index based on GRID_START_MIN
    function timeToIdx(t){
      const [h,m] = t.split(':').map(Number);
      return Math.round(((h*60 + m) - GRID_START_MIN) / 30);
    }

    // Compact range without year
    function formatShortRange(days){
      const sameMonth = days[0].getMonth() === days[4].getMonth();
      const fmtMonth  = new Intl.DateTimeFormat('nl-NL', { month: 'short' });
      const d2 = d => String(d.getDate()).padStart(2,'0');
      const m0 = fmtMonth.format(days[0]);
      const m4 = fmtMonth.format(days[4]);
      return sameMonth
        ? `${d2(days[0])}–${d2(days[4])} ${m4}`
        : `${d2(days[0])} ${m0}–${d2(days[4])} ${m4}`;
    }

    // Capitalize first letter of Dutch weekday/month names
    function capFirst(s){ return s.charAt(0).toUpperCase() + s.slice(1); }
    
    // ISO week number (for "week 43" like Outlook)
    function getISOWeek(d){
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const day = (date.getUTCDay() + 6) % 7; // Mon=0..Sun=6
      date.setUTCDate(date.getUTCDate() - day + 3); // Thursday
      const firstThursday = new Date(Date.UTC(date.getUTCFullYear(), 0, 4));
      const week = 1 + Math.round(((date - firstThursday) / 86400000 - 3) / 7);
      return week;
    }
    
    // Outlook-like range: "20–26 Oktober, 2025 (week 43)"
    function formatOutlookRange(days){
      const dd = d => String(d.getDate()).padStart(2, '0');
      const monthLong = new Intl.DateTimeFormat('nl-NL', { month: 'long' }).format(days[0]);
      const monthCap  = capFirst(monthLong);
      const year      = days[0].getFullYear();
      const isoWeek   = getISOWeek(days[0]); // Monday of shown week
      return `${dd(days[0])}–${dd(days[4])} ${monthCap}, ${year} (week ${isoWeek})`;
    }

    function renderWeek(){
      const days = weeks[weekIdx];

      // —— Outlook-style column headers (big date + small weekday) —— //
      {
        const heads = document.querySelectorAll('#timetable thead th');
        // heads[0] is "Tijd", heads[1..5] are the weekdays
        for (let i = 1; i <= 5; i++) {
          const d = days[i - 1];
          const dd = String(d.getDate()).padStart(2, '0');
          const w  = capFirst(new Intl.DateTimeFormat('nl-NL', { weekday: 'long' }).format(d));
          heads[i].innerHTML = `<div class="dayhead"><div class="d">${dd}</div><div class="w">${w}</div></div>`;
        }
      }

      // ——— planner bar text ———
      document.getElementById('weekRange').textContent = formatOutlookRange(days);
      
      // Hide the separate week chip (week number is in the title now)
      const chip = document.getElementById('weekChip');
      if (chip) chip.style.display = 'none';


      /// ——— grid skeleton ———
      const times = [];
      for (let mins = GRID_START_MIN; mins <= GRID_END_MIN; mins += 30) {
        const hh = String(Math.floor(mins/60)).padStart(2,'0');
        const mm = String(mins % 60).padStart(2,'0');
        times.push(`${hh}:${mm}`);
      }
      grid.innerHTML='';
      times.forEach(t=>{
        const tr=document.createElement('tr');
        const th=document.createElement('th'); th.className='align-top p-2 w-24 text-left text-slate-600'; th.textContent=t; tr.appendChild(th);
        for(let c=0;c<5;c++){ const td=document.createElement('td'); td.className='relative h-14 align-top border-t border-slate-100 cell'; tr.appendChild(td); }
        grid.appendChild(tr);
      });

      const rows=grid.querySelectorAll('tr');
      const slotHeight=rows[0].children[1].getBoundingClientRect().height || 56;

      // ——— collect week events ———
      const startOfWeek=days[0]; const endOfWeek=days[4];
      const weekEvents=WORKSHOPS.filter(w=>{ const d=new Date(w.date); return d>=new Date(startOfWeek.toDateString()) && d<=new Date(endOfWeek.toDateString()); });

      // group by weekday
      const byDay=[[],[],[],[],[]];
      weekEvents.forEach(ev=>{
        const d=new Date(ev.date); const col=((d.getDay()+6)%7);
        if(col<=4) byDay[col].push(ev);
      });

      // ——— render with lane calculation for overlaps ———
      byDay.forEach((events, col) => {
        events.sort((a,b)=> timeToIdx(a.start) - timeToIdx(b.start) || timeToIdx(a.end) - timeToIdx(b.end));

        const active=[]; let cluster=[]; let clusterMax=-1;
        const finishCluster=()=>{ const n=clusterMax+1; cluster.forEach(e=>e._lanes=n); cluster=[]; clusterMax=-1; };

        events.forEach(ev=>{
          let s = timeToIdx(ev.start);
          let e = timeToIdx(ev.end);
          
          // clamp to grid (prevents negative or overshoot indices)
          s = Math.max(0, s);
          e = Math.max(s + 1, Math.min(times.length, e));

          for(let i=active.length-1;i>=0;i--){ if(active[i].end<=s) active.splice(i,1); }
          if(active.length===0 && cluster.length) finishCluster();

          const used=new Set(active.map(a=>a.lane)); let lane=0; while(used.has(lane)) lane++;
          ev._lane=lane; ev._startIdx=s; ev._endIdx=e;
          active.push({end:e,lane}); cluster.push(ev); if(lane>clusterMax) clusterMax=lane;
        });
        if(cluster.length) finishCluster();

        events.forEach(ev=>{
          const startCell=rows[ev._startIdx].children[col+1];
          const div=document.createElement('div'); div.className='event';
          const durationRows=Math.max(1, ev._endIdx-ev._startIdx);
          div.style.top='2px'; div.style.height=`calc(${durationRows*slotHeight}px - 4px)`;

          const gap=4, widthPct=100/ev._lanes;
          div.style.width=`calc(${widthPct}% - ${gap}px)`;
          div.style.left =`calc(${ev._lane*widthPct}% + 2px)`;

          div.innerHTML=`<strong>${ev.title}</strong><br><span>${ev.start}–${ev.end}</span><br><em>${ev.speaker}</em>`;

          // availability chip in block (supports "nog niet geopend")
          (function(){
            const st = getEnrollmentState(ev);
            const chip = document.createElement('div');
          
            if (st.state === 'not_open') {
              chip.className = 'avail-chip not-open icon-only';
              chip.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M7 10V8a5 5 0 1 1 10 0v2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="5" y="10" width="14" height="10" rx="2" stroke="currentColor" stroke-width="1.8"/>
                  <circle cx="12" cy="15" r="1.4" fill="currentColor"/>
                </svg>`;
              chip.setAttribute('title','Inschrijvingen nog niet geopend');
              chip.setAttribute('aria-label','Inschrijvingen nog niet geopend');
              div.appendChild(chip);
              return;
            } else if (st.state === 'full') {
              chip.className = 'avail-chip full';
              chip.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M6 10V8a6 6 0 1112 0v2M5 10h14v8a2 2 0 01-2 2H7a2 2 0 01-2-2v-8z"
                        stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Vol</span>`;
            } else if (st.state === 'open') {
              chip.className = 'avail-chip';
              chip.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M9 12l2 2 4-4M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10z"
                        stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>${st.left} vrij</span>`;
            } else {
              return; // no chip if unknown
            }
          
            div.appendChild(chip);
          })();

          div.addEventListener('click',()=>openModal(ev));
          startCell.appendChild(div);
        });
      });

      renderMobileAgenda();
    }

    function renderMobileAgenda(){
      const list = document.getElementById('mobileList'); if(!list) return;
      const days = weeks[weekIdx];
      const startOfWeek = new Date(days[0].toDateString());
      const endOfWeek   = new Date(days[4].toDateString());

      const weekEvents = WORKSHOPS
        .filter(w => { const d = new Date(w.date); return d >= startOfWeek && d <= endOfWeek; })
        .sort((a,b) => +new Date(a.date) - +new Date(b.date) || a.start.localeCompare(b.start));

      const fmtDay = new Intl.DateTimeFormat('nl-NL', { weekday:'long', day:'2-digit', month:'short' });
      const groups = new Map();
      weekEvents.forEach(ev => {
        const key = new Date(ev.date).toDateString();
        if(!groups.has(key)) groups.set(key, []);
        groups.get(key).push(ev);
      });

      list.innerHTML = '';
      if(groups.size === 0){
        list.innerHTML = '<p class="text-sm text-slate-600">Geen sessies deze week.</p>';
        return;
      }

      groups.forEach((events, key) => {
        const d = new Date(key);
        const dayHeader = document.createElement('h3');
        dayHeader.className = 'text-base font-semibold text-slate-700 mt-4';
        dayHeader.textContent = fmtDay.format(d);
        list.appendChild(dayHeader);

        events.forEach(ev => {
          const st = getEnrollmentState(ev);
          let chip = '';
          if (st.state === 'not_open') {
            const lock = `
              <svg viewBox="0 0 24 24" fill="none" class="w-3.5 h-3.5">
                <path d="M7 10V8a5 5 0 1 1 10 0v2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                <rect x="5" y="10" width="14" height="10" rx="2" stroke="currentColor" stroke-width="1.8"/>
                <circle cx="12" cy="15" r="1.4" fill="currentColor"/>
              </svg>`;
            chip = `<span class="inline-flex items-center rounded-full border bg-amber-50 text-amber-800 border-amber-200 icon-only"
                           title="Inschrijvingen nog niet geopend" aria-label="Inschrijvingen nog niet geopend">${lock}</span>`;
          } else if (st.state === 'full') {
            chip = `<span class="inline-flex items-center gap-1 text-xs font-semibold px-2 py-1 rounded-full border bg-red-50 text-red-800 border-red-200">
                      Vol
                    </span>`;
          } else if (st.state === 'open') {
            chip = `<span class="inline-flex items-center gap-1 text-xs font-semibold px-2 py-1 rounded-full border bg-emerald-50 text-emerald-800 border-emerald-200">
                      ${st.left} vrij
                    </span>`;
          }

          const card = document.createElement('article');
          card.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-sm';
          const imgFit = (ev.bannerFit === 'cover') ? 'object-cover p-0' : 'object-contain p-0.5';
          card.innerHTML = `
            <div class="flex items-start gap-3">
              <img src="${ev.banner}" alt="" class="w-14 h-14 rounded-lg border border-slate-200 bg-white ${imgFit}">
              <div class="flex-1">
                <h4 class="font-semibold leading-snug">${ev.title}</h4>
                <p class="text-sm text-slate-600">${ev.start}–${ev.end} • ${ev.speaker}</p>
                <div class="mt-2 flex items-center gap-2">${chip}</div>
              </div>
              <button class="text-sm font-medium px-3 py-1.5 rounded-full border border-slate-300 hover:bg-slate-50" data-open="${ev.id}" style="color:var(--brand)">Details</button>
            </div>`;
          list.appendChild(card);
        });
      });

      list.querySelectorAll('button[data-open]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-open');
          const ev = WORKSHOPS.find(x => x.id === id);
          if (ev) openModal(ev);
        });
      });
    }

    // —— NEW: Description loader helpers —— //
    const DESC_CACHE = new Map();

    async function loadDescription(ev){
      const $desc = document.getElementById('mDesc');
      $desc.innerHTML = '<p class="text-sm text-slate-500">Beschrijving laden…</p>';

      const candidates = [];
      if (ev.descFile) candidates.push(ev.descFile);
      candidates.push(`descriptions/${ev.id}.html`);

      for (const url of candidates) {
        try {
          if (DESC_CACHE.has(url)) {
            $desc.innerHTML = DESC_CACHE.get(url);
            return;
          }
          const res = await fetch(url, { cache:'no-store' });
          if (!res.ok) continue;
          const html = await res.text();
          DESC_CACHE.set(url, html);
          $desc.innerHTML = html;
          return;
        } catch (e) {
          /* try next */
        }
      }

      // Fallback to inline text if provided
      if (ev.desc && ev.desc.trim()) {
        $desc.textContent = ev.desc;
      } else {
        $desc.innerHTML = '<p class="text-sm text-slate-500">Geen beschrijving beschikbaar.</p>';
      }
    }

    // ——— Modal logic ———
    let currentWorkshopId = null;

    function openModal(ev){
      currentWorkshopId = ev.id;
      document.getElementById('mBanner').src = ev.banner;
      const mBanner = document.getElementById('mBanner');
      mBanner.classList.remove('object-cover','object-contain','p-1','p-0');
      if (ev.bannerFit === 'cover') {
        mBanner.classList.add('object-cover','p-0');   // fill the square
      } else {
        mBanner.classList.add('object-contain','p-1'); // show full image (default)
      }
      document.getElementById('mTitle').textContent = ev.title;
      document.getElementById('mMeta').textContent =
        `${new Date(ev.date).toLocaleDateString()} • ${ev.start}–${ev.end} • ${ev.speaker}`;

      // CHANGED: load HTML description file (with fallback)
      loadDescription(ev);

      (function(){
        const st = getEnrollmentState(ev);
        const hasForm = !!ev.form;
        const mAvail = document.getElementById('mAvail');
      
        if (st.state === 'not_open') {
          mAvail.textContent = 'Inschrijvingen nog niet geopend';
        } else if (st.state === 'full') {
          mAvail.textContent = 'Beschikbaarheid: VOL';
        } else if (st.state === 'open' && st.left !== null) {
          mAvail.textContent = `Beschikbaarheid: ${st.left} plekken over`;
        } else {
          mAvail.textContent = '';
        }
      
        const tabBtn = document.getElementById('tab-inschrijven');
        const disable = (st.state !== 'open') || !hasForm; // block when not open OR no form
        tabBtn.disabled = disable;
        tabBtn.classList.toggle('opacity-50', disable);
        tabBtn.classList.toggle('cursor-not-allowed', disable);
      })();

      activateTab('info', false);
      document.getElementById('mForm').innerHTML = '';
      document.getElementById('mFormLoader').style.display = '';

      const modal = document.getElementById('modal');
      modal.classList.remove('hidden'); 
      modal.classList.add('flex');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      document.getElementById('modal').classList.add('hidden');
      document.body.style.overflow = '';
      document.getElementById('mForm').innerHTML = '';
    }

    function activateTab(which, loadForm = true){
      const btnInfo = document.getElementById('tab-info');
      const btnReg  = document.getElementById('tab-inschrijven');
      const panelInfo = document.getElementById('panel-info');
      const panelReg  = document.getElementById('panel-inschrijven');

      if(which === 'info'){
        btnInfo.classList.add('active'); btnReg.classList.remove('active');
        panelInfo.classList.add('active'); panelReg.classList.remove('active');
      } else {
        btnReg.classList.add('active'); btnInfo.classList.remove('active');
        panelReg.classList.add('active'); panelInfo.classList.remove('active');
        if(loadForm){ loadFormIframe(currentWorkshopId); }
      }
    }

    function loadFormIframe(workshopId){
      const ev = WORKSHOPS.find(w => w.id === workshopId);
      const url = ev && ev.form;

      const container = document.getElementById('mForm');
      const loader = document.getElementById('mFormLoader');
      container.innerHTML = '';

      if(!url){
        loader.textContent = 'Geen inschrijfformulier beschikbaar.';
        return;
      }

      const iframe = document.createElement('iframe');
      iframe.width = '100%';
      iframe.style.height = '70vh';
      iframe.style.maxHeight = '900px';
      iframe.style.minHeight = '600px';
      iframe.style.border = '0';
      iframe.setAttribute('frameborder','0');
      iframe.setAttribute('allowfullscreen','');
      iframe.src = url;

      loader.style.display = '';
      iframe.addEventListener('load', () => { loader.style.display = 'none'; }, { once: true });

      container.appendChild(iframe);
    }

    // ——— Wire buttons ———
    document.getElementById('closeModal').addEventListener('click', closeModal);
    document.getElementById('modal').addEventListener('click', (e) => {if (e.target === e.currentTarget) closeModal();});
    document.addEventListener('keydown', (e) => {if (e.key === 'Escape') closeModal();});

    document.getElementById('tab-info').addEventListener('click', () => activateTab('info', false));
    document.getElementById('tab-inschrijven').addEventListener('click', () => activateTab('inschrijven', true));

    const prevBtn=document.getElementById('prevWeek');
    const nextBtn=document.getElementById('nextWeek');
    prevBtn.addEventListener('click',()=>{ weekIdx=Math.max(0,weekIdx-1); renderWeek(); prevBtn.blur(); });
    nextBtn.addEventListener('click',()=>{ weekIdx=Math.min(weeks.length-1,weekIdx+1); renderWeek(); nextBtn.blur(); });

    // ——— Availability (per-workshop JSON) ———
    async function fetchAvailabilityFor(id){
      const tryPaths = [ `data/availability/${id}.json`, `data/${id}.json` ];
      const toNum = (v) => {
        if (v === null || v === undefined || v === '') return null;
        const n = Number(String(v).replace(',', '.').trim());
        return Number.isFinite(n) ? n : null;
      };
      const firstNonNull = (...vals) => vals.find(v => v !== null && v !== undefined);

      for (const path of tryPaths){
        try{
          const res = await fetch(path, { cache: 'no-store' });
          if (!res.ok) continue;
          const json = await res.json();
          const capRaw = firstNonNull(
            json.capacity, json.cap, json.max, json.maxSeats, json.max_seats,
            json.places, json.plaatsen, json.aantal, json.total
          );
          const regRaw = firstNonNull(
            json.registered, json.registrations, json.taken, json.occupied,
            json.ingeschreven, json.inschrijvingen
          );
          const capacity   = toNum(capRaw);
          const registered = toNum(regRaw);
          return { ...json, id, capacity: capacity ?? 0, registered: registered ?? 0 };
        } catch(e){ /* try next path */ }
      }
      return null;
    }

    async function loadAllAvailability(){
      const ids = [...new Set(WORKSHOPS.map(w => w.id))];
      const results = await Promise.allSettled(ids.map(fetchAvailabilityFor));
      const map = {};
      results.forEach((r) => { if(r.status==='fulfilled' && r.value){ map[r.value.id] = r.value; } });
      AVAIL = map;
    }

    function buildAvailabilityList(){
      const byId = Object.fromEntries(WORKSHOPS.map(w => [w.id, w]));
      const $ul = document.getElementById('workshops'); if(!$ul) return;
      $ul.innerHTML = '';
      Object.keys(AVAIL).forEach(id => {
        const a = AVAIL[id];
        const left = Math.max((a.capacity ?? 0) - (a.registered ?? 0), 0);
        const meta = byId[id] || { title: id };
        const li = document.createElement('li');
        li.className = 'workshop';
        li.innerHTML = `
          <h3 class="font-semibold">${meta.title}</h3>
          <span class="badge ${left===0 ? 'full' : ''}">
            ${left===0 ? 'Vol' : `${left} plekken over`}
          </span>
          ${left===0 ? '' : `<p><button class="btn" data-wsid="${id}">Inschrijven</button></p>`}
        `;
        $ul.appendChild(li);
      });

      $ul.addEventListener('click', (e) => {
        const btn = e.target.closest('button.btn'); if(!btn) return;
        const id = btn.dataset.wsid;
        const ev = WORKSHOPS.find(x => x.id === id);
        if(ev){ openModal(ev); activateTab('inschrijven', true); }
      }, { once: true });
    }

    // ——— Auto-size calendar wrapper to viewport minus header+bar ———
    (function(){
      const wrap = document.getElementById('calendarWrap');
      function setMaxHeight(){
        if(!wrap) return;
        const headerH = document.getElementById('siteHeader')?.offsetHeight || 0;
        const barH    = document.querySelector('.planner-bar-wrap')?.offsetHeight || 44;
        const extras  = 48;
        wrap.style.maxHeight = `calc(100vh - ${headerH + barH + extras}px)`;
      }
      addEventListener('resize', setMaxHeight, {passive:true});
      addEventListener('load', setMaxHeight);
      setMaxHeight();
    })();

    // ——— Render flow ———
    async function renderWorkshops(){
      try{
        await loadAllAvailability();
        buildAvailabilityList();       // stays hidden unless you unhide it
        renderWeek();
        renderMobileAgenda();
      }catch(err){
        console.error('Fout bij laden beschikbaarheid', err);
        renderWeek();
      }
    }

    renderWeek();
    renderWorkshops();

    // nav current
    (() => {
      const here = location.pathname.split('/').pop() || 'index.html';
      document.querySelectorAll('.nav-link').forEach(a => {
        if (a.getAttribute('href') === here) a.setAttribute('aria-current','page');
      });
    })();

    // header fade
    addEventListener('scroll', () => {
      document.body.classList.toggle('scrolled', window.scrollY > 8);
    }, { passive: true });
  </script>
</body>
</html>
