<!doctype html>
<html lang="nl">
<head>
  <link rel="icon" type="image/svg+xml" href="casade-logo.svg">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Casade Planning — INNOvember</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --brand:#86BC25; --brand-dark:#5D7A15; }
    .cell { position: relative; pointer-events: none;}
    .event {
      position:absolute;
      left:2px;
      border-radius:10px; padding:6px 8px 28px; font-size:12px; line-height:1.2;
      background:#E6F3D0; border:1px solid #CDE5A5; cursor:pointer; z-index:1; pointer-events:auto;
      box-shadow: 0 1px 0 rgba(0,0,0,.04);
    }
    .event:hover { outline:2px solid var(--brand); }

    .tab-btn { padding:.5rem .75rem; border-radius:.75rem .75rem 0 0; }
    .tab-btn.active { background: white; border:1px solid #e2e8f0; border-bottom: none; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }

    .workshop-list{list-style:none;padding:0;display:grid;gap:1rem}
    .workshop{padding:1rem;border:1px solid #eee;border-radius:.75rem;background:#fff}
    .badge{display:inline-block;padding:.25rem .5rem;border-radius:.5rem;background:#eee;font-size:.9rem;margin-top:.25rem}
    .badge.full{background:#ddd}
    .btn{display:inline-block;margin-top:.5rem;padding:.5rem .75rem;border:1px solid #ccc;border-radius:.5rem;text-decoration:none}

    .tab-btn[disabled]{ pointer-events:none; opacity:.5; }

    /* Availability chip inside calendar events */
    .event .avail-chip{
      position:absolute; bottom:8px; left:8px;
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:9999px; font-size:11px; font-weight:600;
      border:1px solid rgba(0,0,0,.06); box-shadow:0 1px 0 rgba(0,0,0,.04);
      background:#F0FDF4; color:#166534;
    }
    .event .avail-chip svg{ width:14px; height:14px; display:block; }
    .event .avail-chip.full{
      background:#FEF2F2; color:#991B1B;
      border-color: rgba(153,27,27,.15);
    }

    /* Active nav state */
    .nav-link[aria-current="page"]{ color:var(--brand); text-underline-offset:4px; text-decoration:underline; }

    /* animated underline like Home/Blog */
    .link-underline{
      background-image:linear-gradient(currentColor,currentColor);
      background-repeat:no-repeat; background-position:0 100%;
      background-size:0% 2px; transition:background-size .25s ease;
    }
    .link-underline:hover{ background-size:100% 2px; }

    /* header fade on scroll */
    #siteHeader{
      background-color: rgba(255,255,255,.85);
      transition: background-color .25s ease, box-shadow .25s ease;
    }
    body.scrolled #siteHeader{
      background-color: rgba(255,255,255,.72);
      box-shadow: 0 1px 0 rgba(0,0,0,.06);
    }

    /* sticky table head */
    #calendarWrap thead th{
      position: sticky; top: 0; z-index: 20;
      background: #f1f5f9; box-shadow: 0 1px 0 rgba(0,0,0,.06);
    }

    /* Mobile-friendly tweaks */
    @media (max-width: 640px){
      .event{ font-size:11px; padding:6px 6px 24px; }
    }
    @media (max-width: 768px){
      #calendarWrap th:first-child{ position: sticky; left: 0; z-index: 25; background:#ffffff; }
    }

    /* --- Planner bar helpers --- */
    #weekRange { word-break: keep-all; }
    #weekChip  { transition: border-color .2s ease, box-shadow .2s ease; }
    #weekChip:hover { border-color: rgba(0,0,0,.15); box-shadow: 0 1px 0 rgba(0,0,0,.06); }
  </style>
</head>
<body class="bg-slate-50">
  <!-- Header styled like your blog header -->
  <header id="siteHeader" class="sticky top-0 z-30 backdrop-blur bg-white/85 border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="index.html" aria-label="Naar home" class="inline-flex items-center gap-2 shrink-0">
        <img src="casade-logo.svg" alt="Casade" class="h-16 w-auto block" height="64" decoding="async" />
      </a>
      <strong class="text-xl font-bold leading-tight" style="color:var(--brand)">
        Innovatie Blog
      </strong>
      <nav class="ml-auto text-sm flex items-center gap-6">
        <a href="index.html" class="nav-link link-underline hover:text-slate-900">Home</a>
        <a href="blog.html" class="nav-link link-underline hover:text-slate-900">Blog</a>
        <a href="planning.html" class="nav-link link-underline hover:text-slate-900">Planning</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">

    <!-- Planner bar: Vorige | center date + chip | Volgende (no 'Vandaag') -->
    <section class="mb-4">
      <div class="flex items-center justify-between gap-4 rounded-2xl border border-slate-200 bg-white/80 backdrop-blur px-4 py-3 shadow-sm">
        <!-- Left -->
        <button id="prevWeek" class="inline-flex items-center gap-2 rounded-xl border border-slate-300 bg-white px-4 py-2 text-slate-800 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-[var(--brand)]">
          <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M15 18l-6-6 6-6"/></svg>
          <span>Vorige</span>
        </button>

        <!-- Center -->
        <div class="min-w-0 text-center leading-tight">
          <h2 id="weekRange" class="text-2xl font-bold text-slate-900 md:text-3xl md:leading-tight"></h2>
          <div class="mt-2 flex items-center justify-center">
            <span id="weekChip" class="inline-flex items-center gap-1 rounded-full border border-slate-300 px-3 py-1.5 text-sm font-semibold" style="color:var(--brand)">
              <svg viewBox="0 0 24 24" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/>
              </svg>
              <span id="weekChipLabel">Week</span>
            </span>
          </div>
        </div>

        <!-- Right -->
        <button id="nextWeek" class="inline-flex items-center gap-2 rounded-xl border border-slate-300 bg-white px-4 py-2 text-slate-800 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-[var(--brand)]">
          <span>Volgende</span>
          <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9 18l6-6-6-6"/></svg>
        </button>
      </div>
    </section>

    <!-- Timetable -->
    <div id="calendarWrap" class="hidden md:block overflow-auto border border-slate-200 rounded-2xl bg-white">
      <table class="w-full text-sm" id="timetable">
        <thead class="bg-slate-100">
          <tr>
            <th class="w-24 p-3 text-left">Tijd</th>
            <th class="p-3 text-left">Maandag</th>
            <th class="p-3 text-left">Dinsdag</th>
            <th class="p-3 text-left">Woensdag</th>
            <th class="p-3 text-left">Donderdag</th>
            <th class="p-3 text-left">Vrijdag</th>
          </tr>
        </thead>
        <tbody id="grid"></tbody>
      </table>
    </div>

    <!-- Mobile agenda (shown < md) -->
    <section id="mobileAgenda" class="md:hidden mt-4">
      <div id="mobileList" class="space-y-4"></div>
    </section>
    <p class="text-xs text-slate-500 mt-2">Klik op een sessie voor details of inschrijven.</p>

    <!-- Availability-lijst (hidden by default) -->
    <section class="mt-8 hidden" id="availSection">
      <h3 class="text-base font-semibold mb-2">Beschikbaarheid per workshop</h3>
      <ul id="workshops" class="workshop-list"></ul>
      <p class="text-xs text-slate-500 mt-1">Tip: Klik “Inschrijven” om het formulier in deze pagina te openen.</p>
    </section>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 hidden z-50 items-center justify-center bg-black/50 overflow-y-auto p-4">
      <div class="bg-white max-w-2xl w-[92vw] rounded-2xl p-6 max-h-[90vh] overflow-y-auto">
        <div class="flex items-start gap-4">
          <img id="mBanner" class="w-24 h-24 object-cover rounded-xl border border-slate-200" alt="" />
          <div>
            <h3 id="mTitle" class="text-xl font-bold"></h3>
            <p id="mMeta" class="text-sm text-slate-600"></p>
          </div>
          <button id="closeModal" class="ml-auto text-slate-600">✕</button>
        </div>

        <!-- Tabs -->
        <div class="mt-4">
          <div class="flex gap-2 border-b border-slate-200">
            <button id="tab-info" class="tab-btn active">Info</button>
            <button id="tab-inschrijven" class="tab-btn">Inschrijven</button>
          </div>

          <!-- Tab: Info -->
          <div id="panel-info" class="tab-content active border border-slate-200 rounded-b-2xl rounded-tr-2xl p-4">
            <p id="mDesc" class="text-slate-700"></p>
            <p id="mAvail" class="mt-2 text-sm text-slate-600"></p>
          </div>

          <!-- Tab: Inschrijven -->
          <div id="panel-inschrijven" class="tab-content border border-slate-200 rounded-b-2xl rounded-tr-2xl p-0 overflow-y-auto">
            <div id="mFormLoader" class="p-4 text-sm text-slate-500">Formulier laden…</div>
            <div id="mForm"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="workshops.js"></script>

  <script>
    // Use November of this year (if Nov already passed, use next year)
    const today=new Date();
    const currentYear = (today.getMonth() <= 10) ? today.getFullYear() : today.getFullYear()+1; // 10 = Nov
    const NOVEMBER=10;

    // Load workshops from either window.WORKSHOPS or a global const WORKSHOPS
    const WORKSHOPS = (() => {
      if (Array.isArray(window.WORKSHOPS)) return window.WORKSHOPS;
      try { if (Array.isArray(WORKSHOPS)) return WORKSHOPS; } catch {}
      console.warn('Geen workshops geladen — controleer workshops.js of het pad naar het bestand.');
      return [];
    })();

    // Availability map
    let AVAIL = {}; // { id: {capacity, registered, ...}, ... }

    // Build weeks of November (Mon–Fri)
    function getWeeks(year){
      const first=new Date(year, NOVEMBER, 1);
      const last=new Date(year, NOVEMBER+1, 0);
      const start=new Date(first);
      const day=(start.getDay()+6)%7; // Mon=0
      // ✅ FIX: correct offset to Monday
      start.setDate(start.getDate() - day);
      const weeks=[];
      let cur=new Date(start);
      while(cur<=last){
        const days=[];
        for(let i=0;i<5;i++){ const d=new Date(cur); d.setDate(cur.getDate()+i); days.push(new Date(d)); }
        weeks.push(days);
        cur.setDate(cur.getDate()+7);
      }
      return weeks;
    }

    const weeks=getWeeks(currentYear);
    let weekIdx=1;

    const grid=document.getElementById('grid');

    function timeToIdx(t){ const [h,m]=t.split(':').map(Number); return (h-9)*2 + (m>=30?1:0); } // 09:00 baseline

    // Short date range without year, month collapsed when possible
    function formatShortRange(days){
      const sameMonth = days[0].getMonth() === days[4].getMonth();
      const fmtMonth  = new Intl.DateTimeFormat('nl-NL', { month: 'short' });
      const d2 = d => String(d.getDate()).padStart(2,'0');
      const m0 = fmtMonth.format(days[0]);
      const m4 = fmtMonth.format(days[4]);
      return sameMonth
        ? `${d2(days[0])}–${d2(days[4])} ${m4}`
        : `${d2(days[0])} ${m0}–${d2(days[4])} ${m4}`;
    }

    function renderWeek(){
      const days=weeks[weekIdx];

      // --- Planner bar text (no year anywhere) ---
      const range  = formatShortRange(days);
      const weekNo = weekIdx + 1;
      const $weekRange   = document.getElementById('weekRange');
      const $weekChipLbl = document.getElementById('weekChipLabel');
      if ($weekRange)   $weekRange.textContent   = range;
      if ($weekChipLbl) $weekChipLbl.textContent = `Week ${weekNo}`;

      // times 09:00..17:00 per 30 min slots
      const times=[]; for(let h=9; h<=17; h++){ times.push(`${String(h).padStart(2,'0')}:00`); if(h<17) times.push(`${String(h).padStart(2,'0')}:30`); }
      grid.innerHTML='';
      times.forEach(t=>{
        const tr=document.createElement('tr');
        const th=document.createElement('th'); th.className='align-top p-2 w-24 text-left text-slate-600'; th.textContent=t; tr.appendChild(th);
        for(let c=0;c<5;c++){ const td=document.createElement('td'); td.className='relative h-14 align-top border-t border-slate-100 cell'; tr.appendChild(td); }
        grid.appendChild(tr);
      });

      const rows=grid.querySelectorAll('tr');
      const slotHeight=rows[0].children[1].getBoundingClientRect().height || 56;

      // Collect events per weekday for this week (Mon..Fri)
      const startOfWeek=days[0]; const endOfWeek=days[4];
      const weekEvents=WORKSHOPS.filter(w=>{ const d=new Date(w.date); return d>=new Date(startOfWeek.toDateString()) && d<=new Date(endOfWeek.toDateString()); });

      // Group by weekday (0..4 => Mon..Fri)
      const byDay=[[],[],[],[],[]];
      weekEvents.forEach(ev=>{
        const d=new Date(ev.date); const col=((d.getDay()+6)%7);
        if(col<=4) byDay[col].push(ev);
      });

      // ---- Render events with lanes ----
      byDay.forEach((events, col) => {
        events.sort((a,b)=> timeToIdx(a.start) - timeToIdx(b.start) || timeToIdx(a.end) - timeToIdx(b.end));

        const active = [];
        let cluster = [];
        let clusterMaxLane = -1;

        function finalizeCluster(){
          const total = clusterMaxLane + 1;
          cluster.forEach(ev => ev._lanes = total);
          cluster = [];
          clusterMaxLane = -1;
        }

        events.forEach(ev => {
          const s = timeToIdx(ev.start);
          const e = timeToIdx(ev.end);

          for (let i = active.length - 1; i >= 0; i--) {
            if (active[i].end <= s) active.splice(i,1);
          }
          if (active.length === 0 && cluster.length) finalizeCluster();

          const used = new Set(active.map(a => a.lane));
          let lane = 0; while (used.has(lane)) lane++;
          ev._lane = lane;
          ev._startIdx = s;
          ev._endIdx = e;

          active.push({ end: e, lane });
          cluster.push(ev);
          if (lane > clusterMaxLane) clusterMaxLane = lane;
        });

        if (cluster.length) finalizeCluster();

        // paint
        events.forEach(ev => {
          const startCell = rows[ev._startIdx].children[col + 1];
          const div = document.createElement('div');
          div.className = 'event';

          const durationRows = Math.max(1, ev._endIdx - ev._startIdx);
          div.style.top = '2px';
          div.style.height = `calc(${durationRows * slotHeight}px - 4px)`;

          const gap = 4;
          const widthPct = 100 / ev._lanes;
          div.style.width = `calc(${widthPct}% - ${gap}px)`;
          div.style.left  = `calc(${ev._lane * widthPct}% + 2px)`;

          div.innerHTML=`<strong>${ev.title}</strong><br><span>${ev.start}–${ev.end}</span><br><em>${ev.speaker}</em>`;

          (function(){
            const a = AVAIL[ev.id];
            if (!a) return;
            const left = Math.max((a.capacity ?? 0) - (a.registered ?? 0), 0);
            const isFull = left === 0;
            const chip = document.createElement('div');
            chip.className = `avail-chip ${isFull ? 'full' : ''}`;
            chip.setAttribute('aria-label', isFull ? 'Vol' : `${left} plekken vrij`);
            const icon = isFull
              ? `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                   <path d="M6 10V8a6 6 0 1112 0v2M5 10h14v8a2 2 0 01-2 2H7a2 2 0 01-2-2v-8z"
                         stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                 </svg>`
              : `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                   <path d="M9 12l2 2 4-4M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10z"
                         stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                 </svg>`;
            chip.innerHTML = `${icon}<span>${isFull ? 'Vol' : `${left} vrij`}</span>`;
            div.appendChild(chip);
          })();

          div.addEventListener('click',()=>openModal(ev));
          startCell.appendChild(div);
        });
      });
      // ---- end render events ----
      renderMobileAgenda();
    }

    function renderMobileAgenda(){
      const list = document.getElementById('mobileList');
      if(!list) return;

      const days = weeks[weekIdx];
      const startOfWeek = new Date(days[0].toDateString());
      const endOfWeek   = new Date(days[4].toDateString());

      const weekEvents = WORKSHOPS
        .filter(w => {
          const d = new Date(w.date);
          return d >= startOfWeek && d <= endOfWeek;
        })
        .sort((a,b) => {
          const da = +new Date(a.date) - +new Date(b.date);
          if (da !== 0) return da;
          return a.start.localeCompare(b.start);
        });

      const fmtDay = new Intl.DateTimeFormat('nl-NL', { weekday:'long', day:'2-digit', month:'short' });
      const groups = new Map();
      weekEvents.forEach(ev => {
        const key = new Date(ev.date).toDateString();
        if(!groups.has(key)) groups.set(key, []);
        groups.get(key).push(ev);
      });

      list.innerHTML = '';
      if(groups.size === 0){
        list.innerHTML = '<p class="text-sm text-slate-600">Geen sessies deze week.</p>';
        return;
      }

      groups.forEach((events, key) => {
        const d = new Date(key);
        const dayHeader = document.createElement('h3');
        dayHeader.className = 'text-base font-semibold text-slate-700 mt-4';
        dayHeader.textContent = fmtDay.format(d);
        list.appendChild(dayHeader);

        events.forEach(ev => {
          const card = document.createElement('article');
          card.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-sm';

          let chip = '';
          const a = AVAIL[ev.id];
          if (a) {
            const left = Math.max((a.capacity ?? 0) - (a.registered ?? 0), 0);
            const full = left === 0;
            chip = `<span class="inline-flex items-center gap-1 text-xs font-semibold px-2 py-1 rounded-full border ${full ? 'bg-red-50 text-red-800 border-red-200' : 'bg-emerald-50 text-emerald-800 border-emerald-200'}">
                      ${full ? 'Vol' : `${left} vrij`}
                    </span>`;
          }

          card.innerHTML = `
            <div class="flex items-start gap-3">
              <img src="${ev.banner}" alt="" class="w-14 h-14 rounded-lg object-cover border border-slate-200">
              <div class="flex-1">
                <h4 class="font-semibold leading-snug">${ev.title}</h4>
                <p class="text-sm text-slate-600">${ev.start}–${ev.end} • ${ev.speaker}</p>
                <div class="mt-2 flex items-center gap-2">${chip}</div>
              </div>
              <button class="text-sm font-medium px-3 py-1.5 rounded-full border border-slate-300 hover:bg-slate-50" data-open="${ev.id}" style="color:var(--brand)">Details</button>
            </div>
          `;

          list.appendChild(card);
        });
      });

      list.querySelectorAll('button[data-open]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-open');
          const ev = WORKSHOPS.find(x => x.id === id);
          if (ev) openModal(ev);
        });
      });
    }

    // --- Modal logic with tabs ---
    let currentWorkshopId = null;

    function openModal(ev){
      currentWorkshopId = ev.id;

      document.getElementById('mBanner').src = ev.banner;
      document.getElementById('mTitle').textContent = ev.title;
      document.getElementById('mMeta').textContent =
        `${new Date(ev.date).toLocaleDateString()} • ${ev.start}–${ev.end} • ${ev.speaker}`;

      document.getElementById('mDesc').textContent = ev.desc || '';

      (function(){
        const a = AVAIL[ev.id];
        const left = a ? Math.max((a.capacity ?? 0) - (a.registered ?? 0), 0) : null;
        const hasForm = !!ev.form;

        const mAvail = document.getElementById('mAvail');
        if (left === null) { mAvail.textContent = ''; }
        else if (left === 0) { mAvail.textContent = 'Beschikbaarheid: VOL'; }
        else { mAvail.textContent = `Beschikbaarheid: ${left} plekken over`; }

        const tabBtn = document.getElementById('tab-inschrijven');
        const shouldDisable = (left === 0) || !hasForm;
        tabBtn.disabled = shouldDisable;
        tabBtn.classList.toggle('opacity-50', shouldDisable);
        tabBtn.classList.toggle('cursor-not-allowed', shouldDisable);
      })();

      activateTab('info', false);
      document.getElementById('mForm').innerHTML = '';
      document.getElementById('mFormLoader').style.display = '';

      const modal = document.getElementById('modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      document.getElementById('modal').classList.add('hidden');
      document.body.style.overflow = '';
      document.getElementById('mForm').innerHTML = '';
    }

    function activateTab(which, loadForm = true){
      const btnInfo = document.getElementById('tab-info');
      const btnReg  = document.getElementById('tab-inschrijven');
      const panelInfo = document.getElementById('panel-info');
      const panelReg  = document.getElementById('panel-inschrijven');

      if(which === 'info'){
        btnInfo.classList.add('active'); btnReg.classList.remove('active');
        panelInfo.classList.add('active'); panelReg.classList.remove('active');
      } else {
        btnReg.classList.add('active'); btnInfo.classList.remove('active');
        panelReg.classList.add('active'); panelInfo.classList.remove('active');
        if(loadForm){ loadFormIframe(currentWorkshopId); }
      }
    }

    function loadFormIframe(workshopId){
      const ev = WORKSHOPS.find(w => w.id === workshopId);
      const url = ev && ev.form;

      const container = document.getElementById('mForm');
      const loader = document.getElementById('mFormLoader');
      container.innerHTML = '';

      if(!url){
        loader.textContent = 'Geen inschrijfformulier beschikbaar.';
        return;
      }

      const iframe = document.createElement('iframe');
      iframe.width = '100%';
      iframe.style.height = '70vh';
      iframe.style.maxHeight = '900px';
      iframe.style.minHeight = '600px';
      iframe.style.border = '0';
      iframe.setAttribute('frameborder','0');
      iframe.setAttribute('allowfullscreen','');
      iframe.src = url;

      loader.style.display = '';
      iframe.addEventListener('load', () => { loader.style.display = 'none'; }, { once: true });

      container.appendChild(iframe);
    }

    document.getElementById('modal').addEventListener('click', (e) => {if (e.target === e.currentTarget) closeModal();});
    document.addEventListener('keydown', (e) => {if (e.key === 'Escape') closeModal();});

    document.getElementById('closeModal').addEventListener('click', closeModal);
    document.getElementById('tab-info').addEventListener('click', () => activateTab('info', false));
    document.getElementById('tab-inschrijven').addEventListener('click', () => activateTab('inschrijven', true));
    document.getElementById('prevWeek').addEventListener('click',()=>{ weekIdx=Math.max(0,weekIdx-1); renderWeek(); });
    document.getElementById('nextWeek').addEventListener('click',()=>{ weekIdx=Math.min(weeks.length-1,weekIdx+1); renderWeek(); });

    // ---------- Availability (per-workshop JSON) ----------
    async function fetchAvailabilityFor(id){
      const tryPaths = [
        `data/availability/${id}.json`,
        `data/${id}.json`
      ];
      const toNum = (v) => {
        if (v === null || v === undefined || v === '') return null;
        const n = Number(String(v).replace(',', '.').trim());
        return Number.isFinite(n) ? n : null;
      };
      const firstNonNull = (...vals) => vals.find(v => v !== null && v !== undefined);

      for (const path of tryPaths){
        try{
          const res = await fetch(path, { cache: 'no-store' });
          if (!res.ok) continue;
          const json = await res.json();
          const capRaw = firstNonNull(
            json.capacity, json.cap, json.max, json.maxSeats, json.max_seats,
            json.places, json.plaatsen, json.aantal, json.total
          );
          const regRaw = firstNonNull(
            json.registered, json.registrations, json.taken, json.occupied,
            json.ingeschreven, json.inschrijvingen
          );
          const capacity   = toNum(capRaw);
          const registered = toNum(regRaw);
          return { ...json, id, capacity: capacity ?? 0, registered: registered ?? 0 };
        } catch(e){ /* try next path */ }
      }
      return null;
    }

    async function loadAllAvailability(){
      const ids = [...new Set(WORKSHOPS.map(w => w.id))];
      const results = await Promise.allSettled(ids.map(fetchAvailabilityFor));
      const map = {};
      results.forEach((r) => {
        if(r.status === 'fulfilled' && r.value){ map[r.value.id] = r.value; }
      });
      AVAIL = map;
    }

    function buildAvailabilityList(){
      const byId = Object.fromEntries(WORKSHOPS.map(w => [w.id, w]));
      const $ul = document.getElementById('workshops');
      if(!$ul) return;

      $ul.innerHTML = '';
      Object.keys(AVAIL).forEach(id => {
        const a = AVAIL[id];
        const left = Math.max((a.capacity ?? 0) - (a.registered ?? 0), 0);
        const meta = byId[id] || { title: id };
        const li = document.createElement('li');
        li.className = 'workshop';
        li.innerHTML = `
          <h3 class="font-semibold">${meta.title}</h3>
          <span class="badge ${left===0 ? 'full' : ''}">
            ${left===0 ? 'Vol' : `${left} plekken over`}
          </span>
          ${left===0 ? '' : `<p><button class="btn" data-wsid="${id}">Inschrijven</button></p>`}
        `;
        $ul.appendChild(li);
      });

      $ul.addEventListener('click', (e) => {
        const btn = e.target.closest('button.btn');
        if(!btn) return;
        const id = btn.dataset.wsid;
        const ev = WORKSHOPS.find(x => x.id === id);
        if(ev){
          openModal(ev);
          activateTab('inschrijven', true);
        }
      }, { once: true });
    }

    async function renderWorkshops(){
      try{
        await loadAllAvailability();
        buildAvailabilityList();
        renderWeek();
        renderMobileAgenda();
      }catch(err){
        console.error('Fout bij laden beschikbaarheid', err);
        renderWeek();
      }
    }

    // Size the scroll wrapper so the thead can stick cleanly
    (function(){
      const wrap = document.getElementById('calendarWrap');
      function setMaxHeight(){
        if(!wrap) return;
        const headerH = document.getElementById('siteHeader')?.offsetHeight || 0;
        const controlsH = 56; // planner bar height approximation
        const extras = 56;
        wrap.style.maxHeight = `calc(100vh - ${headerH + controlsH + extras}px)`;
      }
      addEventListener('resize', setMaxHeight, {passive:true});
      addEventListener('load', setMaxHeight);
      setMaxHeight();
    })();

    renderWeek();
    renderWorkshops();
  </script>

  <script>
  (() => {
    const here = location.pathname.split('/').pop() || 'index.html';
    document.querySelectorAll('.nav-link').forEach(a => {
      if (a.getAttribute('href') === here) a.setAttribute('aria-current','page');
    });
  })();

  addEventListener('scroll', () => {
    document.body.classList.toggle('scrolled', window.scrollY > 8);
  }, { passive: true });
  </script>
</body>
</html>
